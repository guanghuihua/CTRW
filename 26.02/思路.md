# 操作思路

1. 没有随机扰动，对于Canard系统，什么是relaxation oscillators, regular duck,  headless duck，如何控制参数，使其出现三种现象？
2. 只在慢变量上加噪声 -> random choice
3. 在快变量上噪声 -> stochastic resonance
4. 快慢变量都加噪声
5. 关于使用tau-leaping方法跑Canard模型
6. 空间离散方法和时间离散方法？ 时间离散是否会丢失Canard现象？
7. 不变分布会怎样？


数值格式的指标：精度，长时间行为，开销

思路：
1. 首先，如何画出，斜率参考线？？？（一维立方振子的例子）
2. 如果能够画出斜率参考线，ring density（已经有了）
   中点格式的斜率参考线是怎样的（对于ring density）
3. 对于有闭式不变密度的带退化噪声的SDE，四种方法的斜率参考线(Q_u, Q_c， Q_tilde, mid_point)



你可以在**退化噪声（degenerate-noise）**设置下，完全按照“稳态密度精度 vs 空间步长”的斜率测试来进行实验。但在开始之前，有一个关键点需要明确：

**Zhu 的 tau-leaping 论文中的“中点法（Midpoint）”通常是一个*时间*离散化概念（针对跳跃过程的高阶 tau-leaping 积分器），而 $(Q_u, Q_c)$ 是生成元（Generator）的*空间*离散化。**
因此，在对数-对数图中观察到的相对于**空间**步长 $h$ 的斜率，主要取决于**你所离散化的空间生成元**，除非你的中点法同时也改变了生成元的*空间*逼近方式。

以下我将提供一个具有**显式解析解不变密度**的退化噪声示例，并解释预期的收敛阶以及如何利用斜率参考线进行验证。

---

## 1) 使用具有解析解不变密度的退化噪声系统

一个标准的方案（且符合“三次振子”的精神）是 $(x,v)$ 空间中的**欠阻尼朗之万（Underdamped Langevin / Hypoelliptic）**动力学：

$$
\begin{cases}
dX_t = V_t \, dt \\
dV_t = -U'(X_t) \, dt - \gamma V_t \, dt + \sigma \, dW_t
\end{cases}
\qquad (\text{仅在 } v \text{ 分量有噪声})
$$

由于在 $x$ 方向没有扩散项，这是典型的**退化噪声**。
尽管如此，其不变密度具有闭合形式：

$$
\rho_\infty(x,v) = Z^{-1} \exp \left( -\beta \left( U(x) + \frac{1}{2} v^2 \right) \right), \qquad \beta = \frac{2\gamma}{\sigma^2}
$$

如果你想要“三次振子/双阱”风格的势能，可以取（例如）：
$U(x) = \frac{1}{4}x^4 - \frac{1}{2}x^2$，此时 $\rho_\infty(x,v)$ 依然是显式的。

这正好满足你的需求：**退化噪声 + 显式稳态密度**。

---

## 2) 你在斜率图中测量的是什么“阶（Order）”？

你的图表显示的是“稳态密度误差 vs 空间步长 $h$”。这是一个**空间**收敛性测试：

* 在间距为 $h$ 的网格上构建离散生成元 $Q_h$。
* 通过求解以下方程计算其不变分布 $\pi_h$：
    $$Q_h^\top \pi_h = 0, \qquad \mathbf{1}^\top \pi_h = 1$$
* 将 $\pi_h$ 与精确稳态密度 $\rho_\infty$（在同一网格上离散化后的结果）进行比较。

然后绘制 $\log(\text{error})$ 对 $\log(h)$ 的图。
斜率 $\approx 1$ 表示 $O(h)$，斜率 $\approx 2$ 表示 $O(h^2)$。

---

## 3) 预期收敛阶：退化噪声情况下的 $Q_u, Q_c$ 和 “中点法”

### (A) $Q_u$ 和 $Q_c$
根据设计（并与你的插图一致）：
* **$Q_u$**：通常在空间上是**一阶**的，即误差 $\sim C h$。
* **$Q_c$**：通常在空间上是**二阶**的，即误差 $\sim C h^2$。

在像欠阻尼朗之万这样的亚椭圆/退化系统中，只要满足以下条件，通常**依然能观察到这些阶数**：
1. 离散化保持稳定且非负（有效的马尔可夫生成元）。
2. 边界截断误差不占主导地位。

### (B) Zhu 论文中的中点法：空间阶数是多少？
这取决于你在实现中对“中点”的具体定义：

1.  **如果“中点”仅作为时间积分器**（即：你保留相同的空间 $Q_h$，但用中点 tau-leap 模拟跳跃过程）：
    * **空间**收敛率相对于 $h$ 是**不变的**（取决于 $Q_h$ 是 $O(h)$ 还是 $O(h^2)$）。
    * 你会额外引入依赖于 $\tau$ 的**时间离散化偏差**。
    * 在这种情况下，为了看到清晰的空间斜率，你必须使 $\tau$ 足够小，使时间偏差相对于空间误差可以忽略（例如，若要空间二阶误差占主导，通常需要 $\tau \propto h^2$）。

2.  **如果你的“中点”法也改变了生成元的空间离散化方式**：
    * 形式上，中点/中心差分逼近对于平滑解是**二阶**的。
    * 然而，在生成元形式中，必须强制**跳跃速率非负**。许多“中点/中心”构造在不加修改的情况下会破坏正定性，而保持正定性的修改往往会将对流占优方向的有效阶数降回**一阶**。

**实际预期（马尔可夫生成元离散化中最常见的情况）：**
* 如果中点方案通过类似迎风（Upwind）的选择来保持正定性，你最可能观察到 **$O(h)$**。
* 如果它确实实现了二阶精度的生成元并保持了有效的速率，你可以观察到 **$O(h^2)$**。

---

## 4) 如何通过斜率参考线进行验证（如你图所示）

### 步骤 1：选择网格序列
取 $h_k = h_0 / 2^k$，在两个方向（$x$ 和 $v$）进行同步细化。

### 步骤 2：计算 $\pi_{h_k}$
**优选方法**：直接求解 $Q_h^\top \pi_h = 0$，而不是使用蒙特卡洛（SSA）。因为蒙特卡洛的统计噪声会掩盖收敛斜率。
如果你坚持使用 SSA/tau-leaping，你必须让采样误差远低于离散化误差：
* 采样误差按 $N^{-1/2}$ 缩放。
* 离散化误差按 $h^p$ 缩放。
* 你需要 $N \gg h^{-2p}$。对于 $p=2$，这意味着 $N \propto h^{-4}$，计算成本极高。

### 步骤 3：计算误差指标
常用的选择是：
$$e(h) = \frac{|\pi_h - \pi^*(h)|_1}{|\pi^*(h)|_1}$$
其中 $\pi^*(h)$ 是在网格点上取值并归一化后的精确密度。

### 步骤 4：斜率估算
使用连续的斜率计算：
$$p_k = \frac{\log(e(h_{k+1})/e(h_k))}{\log(h_{k+1}/h_k)}$$

---

## 5) 退化噪声环境下的两个常见坑点

1.  **边界截断占主导**：精确不变密度定义在 $\mathbb{R}^2$ 上。在有限区域内，你施加的边界条件（反射/吸收/周期性）可能会产生 $O(1)$ 的建模误差，从而破坏斜率。
    * **修正**：扩大定义域使边界处的质量微乎其微，并对盒子内的“精确”密度重新归一化。
2.  **时间离散化偏差污染空间斜率**（如果使用 tau-leaping）：
    * **修正**：将 $\tau$ 缩放得足够小（通常 $\tau \propto h^2$）以确保空间误差占主导。
